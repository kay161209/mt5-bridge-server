# MT5 Bridge API 実装計画

## プロジェクト概要
MetaTrader 5をFastAPI/WebSocketで操作するブリッジAPIサーバー。RESTful APIとWebSocket接続の両方をサポートし、MT5との通信を可能にします。

## システム構成

### コアコンポーネント
1. FastAPI アプリケーション
   - メインアプリケーションサーバー
   - REST APIエンドポイント提供
   - WebSocket接続のサポート
   - CORSミドルウェア対応

2. セッション管理システム
   - プロセスマネージャー（親プロセス）
     - セッションの作成・管理
     - 子プロセスの監視と制御
     - プロセス間通信（IPC）の管理
   - MT5セッション（子プロセス）
     - 個別のPythonプロセスとしてMT5を初期化
     - セッション固有のMT5インスタンス管理
     - 親プロセスとのIPC通信
   - セッションの状態管理
     - プロセスの生存確認
     - 古いセッションの自動クリーンアップ
     - リソース使用状況の監視

3. MT5連携機能
   - MT5ポータブル版との連携
   - 注文処理
   - マーケットデータの取得

### セキュリティ機能
- トークンベースの認証
- WebSocket接続の認証
- セッション管理のセキュリティ
- プロセス間通信のセキュリティ

## 実装ステータス

### 完了済み機能
- [x] 基本的なアプリケーション構造
- [x] 初期セッション管理システム
- [x] トークン認証
- [x] WebSocket基本実装
- [x] ロギングシステム
- [x] エラーハンドリング
- [x] クリーンアップ処理

### 今後の実装予定
- [ ] マルチプロセスセッション管理の実装
  - [ ] プロセスマネージャーの設計と実装
  - [ ] 子プロセスでのMT5初期化処理
  - [ ] プロセス間通信の実装
  - [ ] セッション状態の監視システム
- [ ] WebSocketセッション管理の改善
- [ ] より詳細なMT5操作機能
- [ ] エラーレポーティングの強化
- [ ] パフォーマンスモニタリング
- [ ] ドキュメンテーションの拡充

## 技術スタック
- Python 3.x
- FastAPI
- WebSocket
- MetaTrader 5 API
- APScheduler（スケジューリング）
- logging（ロギング）
- multiprocessing（プロセス管理）
- subprocess（子プロセス制御）

## 開発環境セットアップ
1. Python仮想環境の作成
```bash
python -m venv .venv
source .venv/Scripts/activate      # Windows: .venv\Scripts\activate
```

2. 依存関係のインストール
```bash
pip install -r requirements.txt
```

3. 環境変数の設定
```bash
cp .env.example .env               # BRIDGE_TOKEN等を設定
```

4. サーバーの起動
```bash
uvicorn main:app --reload --port 8000
```

## API仕様
- REST API: http://localhost:8000/docs (Swagger UI)
- WebSocket: ws://localhost:8000/v5/ws?token=<BRIDGE_TOKEN>

## 注意事項
- MT5ポータブル版のパスが正しく設定されていることを確認
- セッションの有効期限と自動クリーンアップの設定を確認
- 本番環境でのセキュリティ設定の見直し
- プロセス管理とリソース使用量の監視が重要
- 子プロセスの適切な終了処理の実装が必要

## 今後の展望
1. パフォーマンス最適化
   - プロセス間通信の効率化
   - リソース使用量の最適化
2. エラーハンドリングの強化
   - プロセス障害時の回復機能
   - セッション再接続機能
3. テストカバレッジの向上
4. モニタリング機能の追加
   - プロセス状態の可視化
   - リソース使用状況の監視
5. ドキュメンテーションの充実化 