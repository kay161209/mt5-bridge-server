# MT5 Bridge API 実装計画

## プロジェクト概要
MetaTrader 5をFastAPI/WebSocketで操作するブリッジAPIサーバー。RESTful APIとWebSocket接続の両方をサポートし、MT5との通信を可能にします。

## システム構成

### コアコンポーネント
1. FastAPI アプリケーション
   - メインアプリケーションサーバー
   - REST APIエンドポイント提供
   - WebSocket接続のサポート
   - CORSミドルウェア対応

2. セッション管理システム
   - プロセスマネージャー（親プロセス）
     - セッションの作成・管理
     - 子プロセスの監視と制御
     - プロセス間通信（IPC）の管理
     - セッションの状態管理
   - MT5セッション（子プロセス）
     - 個別のPythonプロセスとしてMT5を初期化
     - セッション固有のMT5インスタンス管理
     - 親プロセスとのIPC通信
     - コマンドハンドリングシステム
   - セッションの状態管理
     - プロセスの生存確認
     - 古いセッションの自動クリーンアップ
     - リソース使用状況の監視
     - セッションタイムアウト管理

3. MT5連携機能
   - MT5ポータブル版との連携
   - 注文処理
   - マーケットデータの取得
   - エラーハンドリング

### セキュリティ機能
- トークンベースの認証
- WebSocket接続の認証
- セッション管理のセキュリティ
- プロセス間通信のセキュリティ
- セッションタイムアウト

## 実装ステータス

### 完了済み機能
- [x] 基本的なアプリケーション構造
- [x] マルチプロセスセッション管理システム
  - [x] プロセスマネージャーの実装
  - [x] 子プロセスでのMT5初期化処理
  - [x] プロセス間通信（IPC）の実装
  - [x] セッション状態の監視システム
- [x] トークン認証
- [x] WebSocket基本実装
- [x] ロギングシステム
- [x] エラーハンドリング
- [x] クリーンアップ処理
- [x] セッション管理API
- [x] WebSocketセッション管理
- [x] テスト実装
  - [x] ユニットテスト（セッション管理）
  - [x] 統合テスト（APIエンドポイント）
  - [x] WebSocketテスト
  - [x] 負荷テスト基盤

### 今後の実装予定
- [ ] パフォーマンス最適化
  - [ ] プロセス間通信の効率化
  - [ ] メモリ使用量の最適化
  - [ ] セッション管理の効率化
- [ ] エラーハンドリングの強化
  - [ ] プロセス障害時の自動回復
  - [ ] セッション再接続機能
  - [ ] エラーレポーティングの改善
- [ ] モニタリング機能
  - [ ] プロセス状態の可視化
  - [ ] リソース使用状況の監視
  - [ ] パフォーマンスメトリクスの収集
- [ ] テスト強化
  - [ ] モック/スタブの実装
  - [ ] シナリオテストの追加
  - [ ] 継続的インテグレーション（CI）の設定

## 技術スタック
- Python 3.x
- FastAPI
- WebSocket
- MetaTrader 5 API
- multiprocessing（プロセス管理）
- Pipe（プロセス間通信）
- logging（ロギング）
- psutil（システムモニタリング）
- pytest（テストフレームワーク）
- pytest-asyncio（非同期テスト）
- requests（HTTPクライアント）
- websockets（WebSocketクライアント）

## 開発環境セットアップ
1. Python仮想環境の作成
```bash
python -m venv .venv
source .venv/Scripts/activate      # Windows: .venv\Scripts\activate
```

2. 依存関係のインストール
```bash
pip install -r requirements.txt
```

3. 環境変数の設定
```bash
cp .env.example .env               # BRIDGE_TOKEN等を設定
```

4. サーバーの起動
```bash
uvicorn main:app --reload --port 8000
```

## テスト実行
1. ユニットテスト
```bash
pytest tests/test_session_manager.py -v
```

2. 統合テスト
```bash
pytest tests/test_api.py -v
```

3. WebSocketテスト
```bash
pytest -m websocket -v
```

4. 負荷テスト
```bash
pytest -m load -v
```

5. カバレッジレポート生成
```bash
pytest --cov=app tests/
```

### テスト構成
1. ユニットテスト
   - セッション作成・管理
   - 古いセッションのクリーンアップ
   - コマンド実行
   - エラーケース

2. 統合テスト
   - REST APIエンドポイント
   - 認証処理
   - セッション操作
   - エラーハンドリング

3. WebSocketテスト
   - 接続確立
   - コマンド送受信
   - 認証処理
   - 切断処理

4. 負荷テスト
   - 同時接続（10ユーザー）
   - 継続的なコマンド実行
   - レスポンス時間計測
   - エラー率監視

### テスト基準
- エラー率: 10%未満
- 95パーセンタイルレスポンス時間: 1秒未満
- テストカバレッジ: 80%以上

## API仕様

### REST API エンドポイント
- セッション管理
  - POST /v5/session/create - 新規セッション作成
  - POST /v5/session/{session_id}/command - コマンド実行
  - DELETE /v5/session/{session_id} - セッション削除
  - GET /v5/session/list - セッション一覧取得

### WebSocket
- ws://localhost:8000/v5/ws/{session_id}?token=<BRIDGE_TOKEN>
  - セッション固有のWebSocket接続
  - リアルタイムコマンド実行
  - 双方向通信

## 注意事項
- **このシステムは MetaTrader 5 を使用するため、Windows OS 環境が必要です**
- MT5ポータブル版のパスが正しく設定されていることを確認
- セッションの有効期限と自動クリーンアップの設定を確認
- 本番環境でのセキュリティ設定の見直し
- プロセス管理とリソース使用量の監視が重要
- 子プロセスの適切な終了処理の実装
- メモリリークの防止とリソースの適切な解放
- テスト環境でのMT5パスの設定

## 今後の展望
1. パフォーマンス最適化
   - プロセス間通信の効率化
   - メモリ使用量の最適化
   - セッション管理の改善
2. 運用管理機能の強化
   - 管理ダッシュボードの実装
   - メトリクス収集と可視化
   - アラート機能の実装
3. スケーラビリティの向上
   - 負荷分散機能の実装
   - クラスタリング対応
4. セキュリティ強化
   - 認証システムの拡張
   - 通信の暗号化
   - アクセス制御の細分化
5. テスト自動化の強化
   - CI/CDパイプラインの構築
   - 自動テストの拡充
   - パフォーマンステストの自動化
6. ドキュメンテーションの充実化
   - API仕様書の詳細化
   - 運用マニュアルの整備
   - トラブルシューティングガイドの作成  